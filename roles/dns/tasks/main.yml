---
- name: create nm connection fact
  copy:
    dest: /etc/ansible/facts.d/nmconn.fact
    src: nm-connection.fact
    mode: 0755
  become: yes

- name: reload facts
  setup:
    filter: ansible_local

# Join all search_domains into a space-separated list for ifcfg file
- name: set search domains
  lineinfile:
    dest: "/etc/sysconfig/network-scripts/ifcfg-{{ansible_local.nmconn.nmconn}}"
    regexp: "^DOMAIN="
    line: "DOMAIN=\"{{ search_domains | join(' ') }}\""
  become: yes
  when: search_domains is defined

# We must be able to resolve our own hostname
- name: configure hosts file with default stuff
  lineinfile:
    dest: "/etc/hosts"
    regexp: "^{{ item.address }}(.*)$"
    line: "{{ item.address }}    {{ item.names | join(' ') }}"
  with_items:
    - "{{ hosts_default }}"
  become: yes

- name: configure hosts file with custom stuff
  lineinfile:
    dest: "/etc/hosts"
    regexp: "^{{ item.address }}(.*)$"
    line: "{{ item.address }}    {{ item.names | join(' ') }}"
  with_items:
    - "{{ hosts_custom }}"
  when: hosts_custom is defined
  become: yes
