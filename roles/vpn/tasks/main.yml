---
- name: VPN connections
  template:
    src: "nmconn-{{ item.value.type }}.j2"
    dest: "/etc/NetworkManager/system-connections/{{ item.key }}"
    mode: 0600
    owner: root
    group: root
  become: yes
  notify:
    - restart networkmanager
  with_dict:
    "{{ vpn_connections }}"

- name: build list of files that should exist
  set_fact:
    conn_files: "{{ vpn_connections.keys() | map('regex_replace', '^', '/etc/NetworkManager/system-connections/') | list }}"

- name: get a list of all vpn connections currently on the system
  find:
    path: /etc/NetworkManager/system-connections
    file_type: file
  register: local_vpn_files

- name: purge old vpns
  file:
    path: "{{ item.path }}"
    state: absent
  become: yes
  when: item.path not in conn_files
  with_items:
    "{{ local_vpn_files.files }}"
  notify:
    - restart networkmanager

- name: GlobalProtect gateway fix script
  copy:
    src: 100-gp_gateway.sh
    dest: /etc/NetworkManager/dispatcher.d/100-gp_gateway.sh
    mode: 0755
  become: yes

- name: flush
  meta: flush_handlers
